<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns="http://www.w3.org/1999/xhtml"
                template="./../../../../../template/CrmExTemplate.xhtml"
                xmlns:pa="http://xmlns.jcp.org/jsf/composite/ezcomp/panel"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
                xmlns:ti="http://xmlns.jcp.org/jsf/composite/ezcomp/tile">

    <ui:define name="title">
        Search Result
    </ui:define>

    <ui:define name="content">
        <h:form id="form">
            <pa:CCFlightSearchPanel />

            <h2>#{bookingManager.deptAirport.city.cityName} > #{bookingManager.arrAirport.city.cityName}</h2>
            <p:tabMenu activeIndex="3">
                <c:forEach items="#{bookingManager.previousThreeDays}" var="date" varStatus="index">
                    <p:menuitem value="#{date}" outcome="#{crmExNavController.redirectToSearchFlightResult()}" action="#{bookingManager.searchFlights()}">
                        <f:param name="i" value="#{index.index}" />
                    </p:menuitem>
                </c:forEach>
                <p:menuitem value="#{bookingManager.searchDeptDate}" outcome="#{crmExNavController.redirectToSearchFlightResult()}" icon="ui-icon-star">
                    <f:param name="i" value="3" />
                </p:menuitem>
                <c:forEach items="#{bookingManager.nextThreeDays}" var="date" varStatus="index">
                    <p:menuitem value="#{date}" outcome="#{crmExNavController.redirectToSearchFlightResult()}" actionListener="#{bookingManager.resetDeptDate}">
                        <f:param name="i" value="#{index.index + 4}" />
                    </p:menuitem>
                </c:forEach>
            </p:tabMenu>

            <p:panelGrid>
                <!--Header-->
                <p:row>
                    <p:column colspan="3" rowspan="2">
                        <p:outputLabel value="Sort by: " />
                        <p:commandButton value="Departure time" />
                        <p:commandButton value="Arrival time" />
                        <p:commandButton value="Duration" />
                    </p:column>
                    <c:forEach items="#{bookingManager.getFlightSchedLowestTixFams()}" var="tixFam">
                        <p:column colspan="1" styleClass="alignCenter" >#{tixFam.cabinClass.name}</p:column>
                    </c:forEach>
                </p:row>
                <p:row>
                    <c:forEach items="#{bookingManager.getFlightSchedLowestTixFams()}" var="tixFam">
                        <p:column colspan="1" styleClass="alignCenter" >#{tixFam.name}</p:column>
                    </c:forEach>
                </p:row>

                <p:row>
                    <p:column>Departure</p:column>
                    <p:column><p:outputLabel value="" /></p:column>
                    <p:column>Arrival</p:column>
                </p:row>
                <p:row>
                    <c:forEach items="#{bookingManager.getFlightSchedLowestTixFams()}" var="tixFam">
                        <p:column colspan="1"><p:outputLabel value="" /></p:column>
                    </c:forEach>
                </p:row>

                <!--Flight Schedules-->
                <c:forEach items="#{bookingManager.fligthScheds}" var="flightSched" >
                    <p:row>
                        <p:column>
                            <pa:CCFlightSchedInfoPanel flightSched="#{flightSched}" airport="#{flightSched.leg.departAirport}" date="#{flightSched.departDate}" />
                        </p:column>
                        <p:column>
                            <pa:CCFlightSchedDurationPanel time="#{bookingManager.getFlightSchedTotalDur(flightSched)}" 
                                                           rendered="#{empty bookingManager.getMappedFlightSched(flightSched)}"/>
                            <pa:CCFlightSchedDurationPanel time="#{bookingManager.getFlightSchedTotalDur(flightSched, bookingManager.getMappedFlightSched(flightSched))}" 
                                                           rendered="#{not empty bookingManager.inDirectFlightSchedMaps.get(flightSched)}"/>
                        </p:column>
                        <p:column>
                            <pa:CCFlightSchedInfoPanel flightSched="#{flightSched}" airport="#{flightSched.leg.arrivalAirport}" date="#{flightSched.arrivalDate}" 
                                                       rendered="#{empty bookingManager.getMappedFlightSched(flightSched)}"/>
                            <pa:CCFlightSchedInfoPanel flightSched="#{bookingManager.getMappedFlightSched(flightSched)}" airport="#{bookingManager.getMappedFlightSched(flightSched).leg.arrivalAirport}" date="#{bookingManager.getMappedFlightSched(flightSched).arrivalDate}" 
                                                       rendered="#{not empty bookingManager.inDirectFlightSchedMaps.get(flightSched)}"/>
                        </p:column>

                        <p:column colspan="#{bookingManager.getFlightSchedLowestTixFams().size()}">
                            <p:selectOneRadio id="priceRadio" styleClass="radioChoice" value="#{bookingManager.selectedFb}" converter="flightSchedBookingClsConverter" layout="custom">
                                <p:ajax oncomplete="PF('bar').show()" event="change" update="bar" listener="#{bookingManager.onFlightSchedRadioSelected()}"/>
                                <f:selectItems value="#{bookingManager.getFlightSchedBookingCls(flightSched)}" var="fb" itemValue="#{fb}"/>
                            </p:selectOneRadio>

                                <p:dataGrid styleClass="alignCenter" value="#{bookingManager.getFlightSchedBookingClsHelpers(flightSched)}" var="fbHelper" columns="#{bookingManager.getFlightSchedLowestTixFams().size()}" rowIndexVar="index">
                                    <p:panelGrid styleClass="alignCenter" style="width: 100%;">
                                        <p:row>
                                            <p:column>
                                                <p:outputLabel value="#{bookingManager.testValue(fbHelper)}" />
                                                <p:radioButton for=":form:priceRadio" itemIndex="#{index}"/>
                                            </p:column>
                                        </p:row>
                                    </p:panelGrid>
                                </p:dataGrid>
                            <ui:remove>
                            <p:dataGrid styleClass="alignCenter" value="#{bookingManager.getFlightSchedBookingClsHelpers(flightSched)}" var="fbHelper" columns="#{bookingManager.getFlightSchedLowestTixFams().size()}" rowIndexVar="index">
                                    <p:panelGrid styleClass="alignCenter" style="width: 100%;">
                                        <p:row>
                                            <p:column>
                                                <p:radioButton for=":form:priceRadio" itemIndex="#{index}" rendered="#{fbHelper.available}"/>
                                            </p:column>
                                        </p:row>
                                        <p:row>
                                            <p:column>
                                                <p:outputLabel value="#{bookingManager.testValue(fbHelper)}" />
                                                <p:outputLabel value="S$" rendered="#{fbHelper.available}"/>
                                                <p:outputLabel value="#{fbHelper.flightSchedBookingCls.price}" rendered="#{fbHelper.available}">
                                                    <f:convertNumber maxFractionDigits="1" /> 
                                                </p:outputLabel>
                                                <p:outputLabel value="Not available" rendered="#{not fbHelper.available}" />
                                            </p:column>
                                        </p:row>
                                        <p:row>
                                            <p:column>
                                                <p:outputLabel styleClass="priceTag" value="#{fbHelper.remainedSeatQty} Seat(s) Left" rendered="#{not fbHelper.showLeftSeatQty}" />
                                            </p:column>
                                        </p:row>
                                    </p:panelGrid>
                                </p:dataGrid>
                            </ui:remove>
                        </p:column>
                    </p:row>
                    <p:row>
                        <p:column></p:column>
                        <p:column></p:column>
                        <p:column styleClass="alignRight">
                            <p:commandLink value="More details" oncomplete="PF('flightSchedDetail').show()" >
                                <f:setPropertyActionListener value="#{flightSched}" target="#{bookingBacking.flightSchedule}" />
                            </p:commandLink>
                        </p:column>
                    </p:row>
                </c:forEach>
                <p:commandButton value="Continue" update="messages" action="#{crmExNavController.redirectToPassengerInfo()}" /> 
            </p:panelGrid>

            <p:dialog id="flightSchedDetail" widgetVar="flightSchedDetail" header="Flight Details" showEffect="clip" hideEffect="clip" width="500px;">
                <p:panelGrid>
                    <p:row>
                    </p:row>
                    <p:row>
                        <p:column style="text-align: center;">
                            <p:commandButton value="Close" oncomplete="PF('flightSchedDetail').hide();" />
                        </p:column>
                    </p:row>
                </p:panelGrid>
            </p:dialog>

            <p:notificationBar id="bar" position="bottom" effect="slide" styleClass="notificationBar" widgetVar="bar">
                <!--<pa:CCOneWayPriceBarPanel flightSchedBookingCls="{bookingManager.selectedFbHelper}" />-->

                <p:panelGrid>

                    <p:row>
                        <p:column>
                            <p:outputLabel value="OUTBOUND FLIGHT" />
                        </p:column>
                        <p:column>
                            <p:outputLabel value="#{bookingManager.selectedFbHelper.cabinClass.name} #{bookingManager.selectedFbHelper.ticketFamily.name}" />
                        </p:column>
                        <p:column>
                            <p:outputLabel value="#{bookingManager.selectedFbHelper.flightSchedBookingCls.price}" />
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column>
                            <p:outputLabel value="#{bookingManager.selectedFbHelper.flightSchedBookingCls.flightSchedule.departDate}">
                                <f:convertDateTime pattern="EE, dd MMM yyyy" timeZone="GMT+8" />
                            </p:outputLabel>
                        </p:column>
                        <p:column>
                            <p:outputLabel value="" />
                        </p:column>
                        <p:column>
                            <p:outputLabel value="#{bookingManager.selectedFbHelper.flightSchedBookingCls.flightSchedule.arrivalDate}">
                                <f:convertDateTime pattern="EE, dd MMM yyyy" timeZone="GMT+8" />
                            </p:outputLabel>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column>
                            <p:outputLabel value="#{bookingManager.selectedFbHelper.flightSchedBookingCls.flightSchedule.departDate}">
                                <f:convertDateTime pattern="HH:mm" timeZone="GMT+8" />
                            </p:outputLabel>
                        </p:column>
                        <p:column>
                            <p:outputLabel styleClass="fa fa-arrow-right" />
                        </p:column>
                        <p:column>
                            <p:outputLabel value="#{bookingManager.selectedFbHelper.flightSchedBookingCls.flightSchedule.arrivalDate}">
                                <f:convertDateTime pattern="HH:mm" timeZone="GMT+8" />
                            </p:outputLabel>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column>
                            <p:outputLabel value="#{bookingManager.selectedFbHelper.flightSchedBookingCls.flightSchedule.leg.departAirport.city.cityName}, 
                                           #{bookingManager.selectedFbHelper.flightSchedBookingCls.flightSchedule.leg.departAirport.country.isoCode}" />
                        </p:column>
                        <p:column>
                            <p:outputLabel value="" />
                        </p:column>
                        <p:column>
                            <p:outputLabel value=" #{bookingManager.selectedFbHelper.flightSchedBookingCls.flightSchedule.leg.arrivalAirport.city.cityName} 
                                           #{bookingManager.selectedFbHelper.flightSchedBookingCls.flightSchedule.leg.arrivalAirport.country.isoCode}" />
                        </p:column>
                    </p:row>
                </p:panelGrid>
            </p:notificationBar>
        </h:form>
    </ui:define>

</ui:composition>
